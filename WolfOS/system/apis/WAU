--[[WolfOS is the intellectual property of James Chapman (toxic.wolf@hotmail.co.uk).
Please ask for permission before attempting to redistribute any code relating to WolfOS IN ANY FORM.]]--

--WolfOS Account Utilities

local tUsers = {}

function generateUID()
	local sUID = ""
	local _t = {"0", "1", "2", "3", "4", "5", "6", "7", "8", "9", "a", "b", "c", "d", "e", "f", "g", "h", "i", "j", "k", "l", "m", "n", "o", "p", "q", "r", "s", "t", "u", "v", "w", "x", "y", "z"}
	math.randomseed(os.getComputerID() + os.clock())
	for nChar = 1, 8 do
		if math.random(0, 1) == 0 then
			sUID = sUID .. _t[math.random(1, 10)]
		else
			sUID = sUID .. _t[math.random(11, 36)]
		end
	end
	return sUID
end

encryptPasscode = hash.sha256

function createUser(sUser, sPass)
	local sUID = generateUID()
	tUsers = textutils.unserialize(encryption.fromBase64(WDM.readAllText(WDM.getSystemDataDir() .. "users.dat")))
	table.insert(tUsers, {["uid"] = sUID, ["name"] = sUser, ["hash"] = encryptPasscode(sPass), ["type"] = "user"})
	fs.makeDir(WDM.getUsersDir() .. sUID .. "/")
	WDM.fWrite(WDM.getSystemDataDir() .. "users.dat", textutils.serialize(tUsers))
end

function exists(sUID, sUser)
	tUsers = textutils.unserialize(encryption.fromBase64(WDM.readAllText(WDM.getSystemDataDir() .. "users.dat")))
	for nUser, tUser in ipairs(tUsers) do
		if sUID == tUser.uid or sUser == tUser.name then
			return tUser, nUser
		end
	end
	return nil
end

function changeUserData(sUID, sIndex, sString)
	local tUser, nUser = exists(sUID)
	if tUser then
		tUser[sIndex] = sString
		tUsers[nUser] = tUser
		WDM.fWrite(WDM.getSystemDataDir() .. "users.dat", encryption.toBase64(textutils.serialize(tUsers)))
	end
end

function checkLogin(sUser, sHash)
	local tUser = exists(nil, sUser)
	if tUser then
		if sUser == tUser.name and sHash == tUser.hash then
			return tUser
		end
	end
	return nil
end