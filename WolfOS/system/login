--[[WolfOS is the intellectual property of James Chapman (toxic.wolf@hotmail.co.uk).
Please ask for permission before attempting to redistribute any code relating to WolfOS IN ANY FORM.]]--

WUI.clear("Startup Menu")
WUI.slowPrint("Please enter your User Account ID:", 1, 4)
WUI.registerTextField(6, "[%w%.%-_]", 16, false)
WUI.slowPrint("Please enter your Passcode:", 1, 8)
WUI.registerTextField(10, "%w", 16, true)
local t = WUI.getText(true)
if t then
	local sUserInput, sPassInput = t[1], t[2]
	local tUser
	if not WDM.readSystemData("offline") and not WDM.readServerData("mainframe_state") then
		WNC.send(WDM.readSystemData("mainframe_id"), "connection_request", sUserInput, hash.sha256(sPassInput))
		local nSenderID, sEvent, p1 = WNC.receive(WDM.readSystemData("mainframe_id"), 10)
		if sEvent == "connection_failure" and p1 ~= "invalid_user" then
			WUI.clear("Startup Menu")
			WUI.slowPrint("Could not connect to Mainframe: \n")
			WUI.slowPrint("> " .. sEvent .. ": " .. p1 .. "\n")
			if WUI.choiceMenu("Switch to Offline Mode?") then
				WDM.writeSystemData(true, "offline")
			end
		else
			tUser = p1
		end
	else
		tUser = WAU.checkLogin(sUserInput, hash.sha256(sPassInput))
		if not tUser then tUser = "invalid_user" end
	end
	WUI.clear("Startup Menu")
	if type(tUser) == "table" then
		WUI.slowPrint("Logging in...", nil, nil, true)
		WDM.writeSystemTemp(tUser.uid, "current_uid")
		WDM.writeSystemTemp(tUser.name, "current_user")
		WDM.writeSystemTemp(tUser.hash, "current_hash")
		WDM.writeSystemTemp(tUser.type, "current_type")
		os.run({}, WDM.getSystemDir("system") .. "mainMenu")
	elseif tUser == "invalid_user" then
		WUI.slowPrint("Incorrect User Account ID or Passcode!", nil, nil, true)
	end
end
os.run({}, WDM.getSystemDir("system") .. "startupMenu")